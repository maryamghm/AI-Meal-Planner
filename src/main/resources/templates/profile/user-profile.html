<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>User Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #0F2027, #203A43, #2C5364);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 2rem 0;
    }

    .profile-card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(12px);
      padding: 2rem;
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.35);
      width: 100%;
      max-width: 650px;
      color: #ffffff;
      border: 1px solid rgba(255,255,255,0.15);
    }

    .form-label {
      color: #E0E0E0;
      font-weight: 500;
    }

    .btn-save {
      background-color: #eb8914;
      color: #fff;
      border: none;
      font-weight: 500;
      padding: 0.5rem 2rem;
    }
    .btn-save:hover {
      background-color: #d77d13;
    }

    .btn-skip {
      background-color: transparent;
      border: 1px solid #B0BEC5;
      color: #B0BEC5;
      font-weight: 500;
      padding: 0.5rem 2rem;
    }
    .btn-skip:hover {
      background-color: rgba(255,255,255,0.1);
      border-color: #ffffff;
      color: #ffffff;
    }

    .delete-section {
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .is-invalid {
      border-color: #ff6b6b !important;
      background-color: rgba(255, 107, 107, 0.1) !important;
    }

    .is-valid {
      border-color: #51cf66 !important;
    }

    .invalid-feedback {
      display: none;
      color: #ff6b6b;
      font-size: 0.85rem;
      margin-top: 0.35rem;
    }

    .valid-feedback {
      display: none;
      color: #51cf66;
      font-size: 0.85rem;
      margin-top: 0.35rem;
    }

    .form-control, .form-select {
      background: rgba(255, 255, 255, 0.07);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: #fff;
    }

    .form-control:focus, .form-select:focus {
      background: rgba(255, 255, 255, 0.12);
      border-color: #eb8914;
      box-shadow: 0 0 0 0.25rem rgba(235, 137, 20, 0.25);
      color: #fff;
    }

    .form-text {
      color: rgba(255, 255, 255, 0.7) !important;
    }

    .progress-container {
      margin-bottom: 1.5rem;
    }

    .progress {
      height: 8px;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    .progress-bar {
      background-color: #eb8914;
      transition: width 0.5s ease;
    }

    .section-title {
      border-left: 4px solid #eb8914;
      padding-left: 0.75rem;
      margin: 1.5rem 0 1rem 0;
    }
  </style>
</head>
<body>
<div class="profile-card">
  <h3 class="fw-bold text-center mb-4">Complete Your Profile</h3>

  <!-- Profile Completion Progress Bar -->
  <div class="progress-container">
    <div class="d-flex justify-content-between">
      <span>Profile Completion</span>
      <span id="completion-percentage">0%</span>
    </div>
    <div class="progress">
      <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
  </div>

  <!-- Save Profile Form -->
  <form method="post" th:action="@{/profile}" id="profileForm" novalidate>
    <h5 class="section-title">Personal Information</h5>
    <div class="row mb-3">
      <div class="col">
        <label class="form-label">First Name *</label>
        <input type="text" class="form-control" name="firstName" id="firstName" th:value="${userInformation?.firstName}" required>
        <div class="invalid-feedback">Please provide your first name.</div>
      </div>
      <div class="col">
        <label class="form-label">Last Name *</label>
        <input type="text" class="form-control" name="lastName" id="lastName" th:value="${userInformation?.lastName}" required>
        <div class="invalid-feedback">Please provide your last name.</div>
      </div>
    </div>

    <div class="row mb-3">
      <div class="col">
        <label class="form-label">Age *</label>
        <input type="number" class="form-control" name="age" id="age" th:value="${userInformation?.age}" min="13" max="120" required>
        <div class="invalid-feedback">Please provide a valid age (13-120).</div>
      </div>
      <div class="col">
        <label class="form-label">Birth Date *</label>
        <input type="date" class="form-control" name="birthDate" id="birthDate" th:value="${userInformation?.birthDate}" required>
        <div class="invalid-feedback">Please provide your birth date.</div>
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label">Gender *</label>
      <select class="form-select" name="gender" id="gender" required>
        <option value="">-- Select --</option>
        <option value="MALE" th:selected="${userInformation?.gender == 'MALE'}">Male</option>
        <option value="FEMALE" th:selected="${userInformation?.gender == 'FEMALE'}">Female</option>
        <option value="OTHER" th:selected="${userInformation?.gender == 'OTHER'}">Other</option>
      </select>
      <div class="invalid-feedback">Please select your gender.</div>
    </div>

    <h5 class="section-title">Physical Attributes</h5>
    <div class="row mb-3">
      <div class="col">
        <label class="form-label">Height (cm) *</label>
        <input type="number" class="form-control" name="heightCm" id="heightCm" th:value="${userInformation?.heightCm}" min="100" max="250" required>
        <div class="invalid-feedback">Please provide a valid height (100-250 cm).</div>
      </div>
      <div class="col">
        <label class="form-label">Weight (kg) *</label>
        <input type="number" step="0.1" class="form-control" name="weightKg" id="weightKg" th:value="${userInformation?.weightKg}" min="30" max="300" required>
        <div class="invalid-feedback">Please provide a valid weight (30-300 kg).</div>
      </div>
    </div>

    <h5 class="section-title">Activity & Goals</h5>
    <div class="mb-3">
      <label class="form-label">Activity Level *</label>
      <select class="form-select" name="activityLevel" id="activityLevel" required>
        <option value="">-- Select --</option>
        <option value="SEDENTARY" th:selected="${userInformation?.activityLevel == 'SEDENTARY'}">Sedentary (little or no exercise)</option>
        <option value="LIGHT" th:selected="${userInformation?.activityLevel == 'LIGHT'}">Lightly Active (light exercise 1-3 days/week)</option>
        <option value="MODERATE" th:selected="${userInformation?.activityLevel == 'MODERATE'}">Moderately Active (moderate exercise 3-5 days/week)</option>
        <option value="ACTIVE" th:selected="${userInformation?.activityLevel == 'ACTIVE'}">Active (hard exercise 6-7 days/week)</option>
        <option value="VERY_ACTIVE" th:selected="${userInformation?.activityLevel == 'VERY_ACTIVE'}">Very Active (very hard exercise, physical job)</option>
      </select>
      <div class="invalid-feedback">Please select your activity level.</div>
    </div>

    <div class="mb-3">
      <label class="form-label">Goal *</label>
      <select class="form-select" name="goal" id="goal" required>
        <option value="">-- Select --</option>
        <option value="LOSE_WEIGHT" th:selected="${userInformation?.goal == 'LOSE_WEIGHT'}">Lose Weight</option>
        <option value="MAINTAIN" th:selected="${userInformation?.goal == 'MAINTAIN'}">Maintain Weight</option>
        <option value="GAIN_WEIGHT" th:selected="${userInformation?.goal == 'GAIN_WEIGHT'}">Gain Weight</option>
      </select>
      <div class="invalid-feedback">Please select your goal.</div>
    </div>

    <div class="row mb-3">
      <div class="col">
        <label class="form-label">Meals Per Day *</label>
        <input type="number" class="form-control" name="mealsPerDay" id="mealsPerDay" th:value="${userInformation?.mealsPerDay}" min="1" max="10" required>
        <div class="invalid-feedback">Please specify meals per day (1-10).</div>
      </div>
      <div class="col">
        <label class="form-label">Target Calories (kcal/day)</label>
        <input type="number" class="form-control" name="targetKcalPerDay" id="targetKcalPerDay" th:value="${userInformation?.targetKcalPerDay}" min="800" max="5000">
        <div class="invalid-feedback">Please provide a valid calorie target (800-5000 kcal).</div>
        <div class="form-text">Leave blank to calculate automatically based on your profile</div>
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label">Dietary Preferences</label>
      <select class="form-select" name="dietaryPreferences" id="dietaryPreferences" multiple size="3">
        <option value="VEGAN" th:selected="${userInformation?.dietaryPreferences?.contains('VEGAN')}">Vegan</option>
        <option value="VEGETARIAN" th:selected="${userInformation?.dietaryPreferences?.contains('VEGETARIAN')}">Vegetarian</option>
        <option value="KETO" th:selected="${userInformation?.dietaryPreferences?.contains('KETO')}">Keto</option>
        <option value="PALEO" th:selected="${userInformation?.dietaryPreferences?.contains('PALEO')}">Paleo</option>
        <option value="GLUTEN_FREE" th:selected="${userInformation?.dietaryPreferences?.contains('GLUTEN_FREE')}">Gluten-Free</option>
        <option value="DAIRY_FREE" th:selected="${userInformation?.dietaryPreferences?.contains('DAIRY_FREE')}">Dairy-Free</option>
      </select>
      <div class="form-text">Hold Ctrl (Windows) or Command (Mac) to select multiple.</div>
    </div>

    <div class="d-flex justify-content-between mt-4">
      <button type="submit" class="btn btn-save">Save Profile</button>
      <a th:href="@{/profile/skip}" class="btn btn-skip">Skip for Now</a>
    </div>
  </form>

  <!-- Delete Profile Form (if user already has a profile) -->
  <div th:if="${userInformation?.id != null}" class="delete-section">
    <h5 class="text-center mb-3">Danger Zone</h5>
    <form method="post" th:action="@{'/profile/' + ${userInformation.id}}" id="deleteForm">
      <input type="hidden" name="_method" value="delete">
      <div class="d-grid">
        <button type="submit" class="btn btn-outline-danger" onclick="return confirm('Are you sure you want to delete your profile? This action cannot be undone.')">Delete Profile</button>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('profileForm');
    const progressBar = document.querySelector('.progress-bar');
    const completionPercentage = document.getElementById('completion-percentage');

    // Calculate profile completion percentage
    function calculateCompletion() {
      const requiredFields = form.querySelectorAll('[required]');
      let completedCount = 0;

      requiredFields.forEach(field => {
        if (field.value.trim() !== '') {
          completedCount++;
        }
      });

      const percentage = Math.round((completedCount / requiredFields.length) * 100);
      progressBar.style.width = `${percentage}%`;
      progressBar.setAttribute('aria-valuenow', percentage);
      completionPercentage.textContent = `${percentage}%`;

      return percentage;
    }

    // Validate a single field
    function validateField(field) {
      const value = field.value.trim();
      let isValid = true;

      // Clear previous validation
      field.classList.remove('is-invalid', 'is-valid');
      field.nextElementSibling.style.display = 'none';

      // Check required fields
      if (field.hasAttribute('required') && !value) {
        showError(field, field.nextElementSibling.textContent || 'This field is required.');
        isValid = false;
      }

      // Validate based on field type
      if (value && isValid) {
        switch(field.type) {
          case 'number':
            const min = parseFloat(field.getAttribute('min')) || -Infinity;
            const max = parseFloat(field.getAttribute('max')) || Infinity;
            const numValue = parseFloat(value);

            if (isNaN(numValue) || numValue < min || numValue > max) {
              showError(field, `Please enter a value between ${min} and ${max}.`);
              isValid = false;
            }
            break;

          case 'date':
            const inputDate = new Date(value);
            const today = new Date();

            if (inputDate > today) {
              showError(field, 'Birth date cannot be in the future.');
              isValid = false;
            }
            break;
        }
      }

      // If valid, show success state
      if (isValid && value) {
        field.classList.add('is-valid');
      }

      calculateCompletion();
      return isValid;
    }

    // Show error for a field
    function showError(field, message) {
      field.classList.add('is-invalid');
      const feedback = field.nextElementSibling;
      feedback.textContent = message;
      feedback.style.display = 'block';
    }

    // Validate entire form
    function validateForm() {
      const fields = form.querySelectorAll('input, select');
      let isValid = true;

      fields.forEach(field => {
        if (!validateField(field)) {
          isValid = false;
        }
      });

      return isValid;
    }

    // Add event listeners to all fields for real-time validation
    const fields = form.querySelectorAll('input, select');
    fields.forEach(field => {
      field.addEventListener('blur', () => validateField(field));
      field.addEventListener('input', () => {
        field.classList.remove('is-invalid', 'is-valid');
        field.nextElementSibling.style.display = 'none';
        calculateCompletion();
      });
    });

    // Form submission handler
    form.addEventListener('submit', function(e) {
      e.preventDefault();

      if (validateForm()) {
        this.submit();
      } else {
        // Scroll to first error
        const firstError = this.querySelector('.is-invalid');
        if (firstError) {
          firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
          firstError.focus();
        }
      }
    });

    // Calculate initial completion percentage
    calculateCompletion();

    // Validate fields with existing values on page load
    fields.forEach(field => {
      if (field.value) {
        validateField(field);
      }
    });
  });
</script>
</body>
</html>